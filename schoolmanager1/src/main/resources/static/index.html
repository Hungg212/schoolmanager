<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý sinh viên</title>
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="container mt-4">

<h3 class="mb-3">DANH SÁCH SINH VIÊN</h3>

<input type="text" id="search" class="form-control mb-3"
       placeholder="Tìm theo tên..." onkeyup="searchStudent()">

<table class="table table-bordered table-hover">
    <thead class="table-dark">
    <tr>
        <th>ID</th>
        <th>Tên</th>
        <th>Email</th>
        <th>Hành động</th>
    </tr>
    </thead>
    <tbody id="studentTable"></tbody>
</table>

<hr>

<h4>Thêm sinh viên</h4>
<input id="name" class="form-control mb-2" placeholder="Tên">
<input id="email" class="form-control mb-2" placeholder="Email">

<button class="btn btn-primary" onclick="addStudent()">Thêm</button>

<script>
const API = "http://localhost:8080/api/students";

/* ================= LOAD ================= */
function loadStudents() {
    fetch(API)
        .then(res => {
            if (!res.ok) {
                return res.text().then(t => { throw new Error(t); });
            }
            return res.json();
        })
        .then(data => {
            if (!Array.isArray(data)) {
                throw new Error("Dữ liệu không hợp lệ");
            }
            renderTable(data);
        })
        .catch(err => {
            console.error(err);
            alert("Không thể tải danh sách sinh viên!");
        });
}

/* ================= RENDER ================= */
function renderTable(data) {
    let html = "";
    data.forEach(s => {
        html += `
        <tr>
            <td>${s.id}</td>
            <td>${s.name}</td>
            <td>${s.email}</td>
            <td>
                <button class="btn btn-danger btn-sm"
                        onclick="deleteStudent(${s.id})">
                    Xóa
                </button>
            </td>
        </tr>`;
    });
    document.getElementById("studentTable").innerHTML = html;
}

/* ================= ADD ================= */
function addStudent() {
    const name = document.getElementById("name").value.trim();
    const email = document.getElementById("email").value.trim();

    if (!name || !email) {
        alert("Vui lòng nhập đầy đủ Tên và Email!");
        return;
    }

    const student = { name, email };

    fetch(API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(student)
    })
    .then(res => {
        if (!res.ok) {
            return res.text().then(t => { throw new Error(t); });
        }
        return res.json();
    })
    .then(() => {
        document.getElementById("name").value = "";
        document.getElementById("email").value = "";
        loadStudents();
    })
    .catch(err => {
        console.error(err);
        alert("Thêm sinh viên thất bại!");
    });
}

/* ================= DELETE ================= */
function deleteStudent(id) {
    if (!confirm("Bạn có chắc muốn xóa sinh viên này?")) return;

    fetch(`${API}/${id}`, { method: "DELETE" })
        .then(res => {
            if (!res.ok) {
                return res.text().then(t => { throw new Error(t); });
            }
            loadStudents();
        })
        .catch(err => {
            console.error(err);
            alert("Xóa thất bại!");
        });
}

/* ================= SEARCH ================= */
function searchStudent() {
    const name = document.getElementById("search").value.trim();

    if (name === "") {
        loadStudents();
        return;
    }

    fetch(`${API}/search?name=${encodeURIComponent(name)}`)
        .then(res => {
            if (!res.ok) {
                return res.text().then(t => { throw new Error(t); });
            }
            return res.json();
        })
        .then(data => {
            if (!Array.isArray(data)) {
                throw new Error("Dữ liệu không hợp lệ");
            }
            renderTable(data);
        })
        .catch(err => {
            console.error(err);
        });
}

/* ================= INIT ================= */
loadStudents();
</script>

</body>
</html>
